# 2022-01-06 memo

https://twitter.com/yuuta_aoyagi/status/1475621868657065989

さて、本件の続き。

## 直接に関係する続きの話

2021-12-25夕方、Cygwin setup-x86\*.exe で Python 3.9系を指定したら、なぜか3.8と3.9の両方をインストールするトランザクションが算出された。
以前 QEMU 6.1.0をビルドしようとしたときに Python 3.x 系を要求されたというだけの動機であり、そこまで新しいものが欲しいわけじゃないので、一度キャンセルして3.8系のみを指定しなおした。

## そのはるか先まで続く別件

### その1: QEMU を野良ビルドして、試しに Alpine Linux

再度 QEMU の configure を試したところ、ビルドシステムの ninja が足りないと言われた。
同26日、これをインストール。
その次には glib-gthread のバージョンが合わないと言われた。
Cygwin の mingw64-x86\_64-glib2.0 はそれほど新しくなかったので、 QEMU の GitLab リポジトリで configure の blame を見ていつこのバージョンを要求するようになったかを調べた。
どうやら6.1.0かららしいので、ビルドする QEMU を6.0.1に妥協。
ここまでの準備をすべて終えるとビルドは待つだけで終わった。
「 Cygwin 上で mingw を使ってものをビルドする」というのが初めてでいまいちお作法が分からず、いくつか困惑。

まず、 mingw 側の DLL は `/usr/x86_64-w64-mingw32/sys-root/mingw/bin` にインストールされるらしく、そこに PATH を通すのは手でやった。
これが正しいのかも分からん。
もう一つが、そうやって DLL を読めるようにしてスモークテストとしての `-version` くらいは走ったとしても、 `make check` の類は走らないらしいということ。
考えてみればそこまで変な話ではなく、「 Cygwin ホストで Windows ネイティブへのクロスコンパイル」をやったから仕方ないということなんだろう。
テストスイートから渡るパスの引数は Cygwin の表記であって、 Windows の立場では(バックスラッシュとスラッシュの読み替えを含めても)読めないものだ、という失敗のしかたしてたわけだし。

最初に試したのが、2021-09-21朝にダウンロードだけして放ってあった `alpine-virt-3.14.2-x86_64.iso` 。
Cygwin に足すパッケージを少なくとどめてビルドしたので、 SDL などの分かりやすい GUI はなし。
それでも QEMU は組み込みの VNC サーバでエミュレート対象のマシンのグラフィック出力を取り出せるんだから、柔軟でよろしい。
今回は `-nographic` で使わないけどね。
ビルドもさして難しくなかったし、 Alpine Linux はすんなり起動したし、順調。
QEMU に `-nographic` を渡すと、シリアルポート(とモニタ)が stdio につながるので、コンソール触るだけならこれが手軽。

余談: https://twitter.com/yuuta_aoyagi/status/1439252655457538049 のツイートの後もいくらか調べていた結果、有志がインストーラーにパッケージしたビルド済みバイナリを配布してるのと、インストーラーなしで .7z に固めてあるバイナリ(ただし2.6.0まで)を見つけた。
私が探していてなくなったと勘違いしたのは後者で、バージョンが2.6.0というと2016年のもの。
これだけ古いと脆弱性がたくさんあるだろうし常用はしたくない。
ということで、有志の非公式のビルド済みバイナリをインストールするか、自分で野良ビルドするかの2択で、今回は後者を選んだってわけ。(余談ここまで)

### その2: Amazon Linux 2

年末年始に遊んだのが `amzn2-kvm-2.0.20211201.0-x86_64.xfs.gpt.qcow2` ということで、 Amazon Linux 2を AWS の外で走らせられるってやつ。
最初忘れてた SHA256SUMS をダウンロードしたのは、帰省の特急の中で不安定なモバイル Wi-Fi 越しだったりする。
さて、 [Amazon Linux 2をオンプレミスで走らせるドキュメント](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/amazon-linux-2-virtual-machine.html) には初回の起動時に行われる設定を ISO ファイルに収める手続きが紹介されているが、実はもっと汎用的に、その初期化は cloud-init の NoCloud データソースを使うことが[明記されている](https://cdn.amazonlinux.com/os-images/2.0.20211201.0/README.cloud-init) 。
このあたりの話は、 https://github.com/awsdocs/amazon-ec2-user-guide/issues/123 の人もおっしゃっている。
それから、 QEMU にはホスト上のディレクトリツリーを FAT な仮想ディスクに見せかける機能があることを[別件](https://knowledge.sakura.ad.jp/23597/) で知っていた。
これは組み合わせるしかないでしょ。
とはいえ、なぜかうまく動かなかったんだけど(具体的なエラーの内容は、忘れたし stderr の古くてもう読めないところに行ってしまった)。
エラーの原因を深追いしなかったのは、 NoCloud データソースが HTTP 越しにも seed を読めるというプラン B があるのを知っていたから。
となれば、ホストで `python -m http.server ${port} &` を準備し、 QEMU 上の Amazon Linux 2に `ds=nocloud-net;s=http[:]//10.0.2[.]2:${port}/` を知らせればよい。

デフォルトの設定で起動させた Amazon Linux 2にはコンソールからログインできるユーザがおそらくなく、最初の起動のときに cloud-init 経由で SSH の公開鍵を設定するのがほぼ前提になっている。
これは AWS の外で走らせようという今回も同じであって、 user-data ファイルを書くのはホスト環境で作った SSH 鍵の公開部分を注入するのが最大の動機である。

さて、 Amazon EC2 で Amazon Linux 2を起動するときには自動生成されたホスト SSH 鍵のフィンガープリントがコンソールに出力されるものだが、ここまでの準備で起動してみたところ、シリアルポートには流れてこなかった。
QEMU ホストの localhost からポート転送で sshd に接続するため、ホスト鍵を検証するのは必須ではないのだが、一応やっておきたい。
というわけで、「 POST リクエストを受け取ったら適当に記録する HTTP サーバ」を適当にホストに用意して、 user-data には「ホスト鍵のフィンガープリントを生成して curl でそっちに POST するワンライナー」を追加した。
これはこれで期待どおりに動いたんだが、このメモの執筆までの数週間にあった何度かの機会で試したところ、シリアルポートにホスト鍵のフィンガープリントが現れることも現れないこともあった。
最初の1回は現れないほうを引いたんだろう。
原因は調べてない。

ここまでの試行錯誤で書いてきたコマンドラインはシェルスクリプトや Makefile の形にまとめた。
他のところで試したくなったら、 SSH 鍵を用意して make コマンドを何回か使うだけで、ディスクイメージの準備・起動・ SSH 接続までを試せるようになっている。

この Amazon Linux 2の上でやったことといえば、 `sudo yum install -y docker` とか、 `sudo docker run --rm ruby:${tag} ruby -e 'puts "Hello, Ruby world with #{RUBY_DESCRIPTION}"'` みたいなお試しとかだった。
これらすべてが走る QEMU は Win10 ノートで動いているわけだが、かなりの時間(1日の半分以上)はスリープに入る都合で、時計がひたすらずれていくという現象を見た。
まあ、しかたないと言えばそのとおりで、こうやってまじまじと Amazon Linux 2を触ったので、 chrony とかいう NTP ・時計管理のプログラムを学ぶことになった。
この chrony というプログラムは、 makestep しない限りは slew でゆっくり時計を合わせていくから、「ホストのスリープで時間がいきなり数時間飛ぶ」みたいな環境では扱いにくいかもしれない。

### その3: 手元の PC における開発環境を再考

ここまででやってきた「仮想マシンとその上で Docker & Ruby 」という構成は、「 Cygwin 向け Ruby の最近のバージョンがなかなか配布されない」「今常用している Windows 10 + Cygwin + Ruby よりもっと一般的に使われるものに近い環境を用意したい」というのがきっかけであった。

先の調べもので分かっているとおり、 QEMU on Windows にはビルド済みバイナリの公式のパッケージはない。
そのため野良ビルドは避けられないものと考えるが、ビルド環境としては QEMU 以外の方法で GNU/Linux 環境を作るか、 Cygwin の上で mingw を使うかの実質的に2択になる。

そうこうしているうちにこのあたりの取り組みは、たしか2017年に始めたと記憶している、「作り直しやすい開発環境を構築する手順を明確にする」というプロジェクトの一番後ろに増える新しいステップなのだと気がついた。
当時は Cygwin 上の Emacs + Ruby である程度まで満足して中断していたが、今回遊んでいた部分は「構築した Cygwin 環境を使って QEMU と Linux + Docker 環境を作る」というステップの開発だったわけだ。

このプロジェクト、ある程度固まって覆らないだろうというステップは、

- Web ブラウザをインストールする
- (そのブラウザを使って) Cygwin の `setup-x86*.exe` をダウンロードする
- インストールするべきパッケージの依存関係を解決し一覧を得る
- 一覧にあがったすべてのパッケージをインストールしてよいかどうかを(ある私的な基準で)確認する (※)(未解決)
- 決定したパッケージ群をインストールする
- rbenv + ruby-build をインストールして `rbenv install $chosen_newer_version` (未実施)
- Cygwin + mingw を使って QEMU をビルドする (新)
- (必要に応じて Ruby を補助に使い、) QEMU の上に Linux + Docker 環境を作る (新)

あたりが見えている。
Cygwin のインストールが済むまではどんな作業もやりにくいので現在のところ(※)は不完全で、 Cygwin ごとインストールした後に、インストールして問題なかったかどうかを事後的にチェックしている。
今回はずっと前にインストールして手元にあった Cygwin + Ruby を QEMU + Amazon Linux 2に使ったけど、最近のバージョンを使うべきではあるので rbenv のステップが追加。
これらのステップとは直交して、(1) AWS のほうにも似た精神のブートストラップを検討中だし、(2)提供されているところは電子署名も検証したいと思うし、(3)何年か前に使うのをやめた Cygwin の派生ディストリビューションにあった便利なものを、今の Cygwin にも再現したいところはある。

やれやれ、まだまだ先は長そうだ。

### 余談と終わりに

Win10 ノートで運用にミスがあり、2022-01-06の夕方に不意に再起動がかかった。
QEMU 上のゲスト Amazon Linux 2にとっては、クラッシュとかハードシャットダウンとかに見えるんだろう。
