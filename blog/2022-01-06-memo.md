# 2022-01-06 memo

https://twitter.com/yuuta_aoyagi/status/1475621868657065989

さて、本件の続き。

2021-12-25夕方、Cygwin setup-x86\*.exe で Python 3.9系を指定したら、なぜか3.8と3.9の両方をインストールするトランザクションが算出された。
以前 QEMU 6.1.0をビルドしようとしたときに Python 3.x 系を要求されたというだけの動機であり、そこまで新しいものが欲しいわけじゃないので、一度キャンセルして3.8系のみを指定しなおした。
再度 configure を試したところ、ビルドシステムの ninja が足りないと言われた。
同26日、これをインストール。
その次には glib-gthread のバージョンが合わないと言われた。
Cygwin の mingw64-x86\_64-glib2.0 はそれほど新しくなかったので、 QEMU の GitLab リポジトリで configure の blame を見ていつこのバージョンを要求するようになったかを調べた。
どうやら6.1.0かららしいので、ビルドする QEMU を6.0.1に妥協。
ここまでの準備をすべて終えるとビルドは待つだけで終わった。
「 Cygwin 上で mingw を使ってものをビルドする」というのが初めてでいまいちお作法が分からず、いくつか困惑。

まず、 mingw 側の DLL は `/usr/x86_64-w64-mingw32/sys-root/mingw/bin` にインストールされるらしく、そこに PATH を通すのは手でやった。
これが正しいのかも分からん。
もう一つが、そうやって DLL を読めるようにしてスモークテストとしての `-version` くらいは走ったとしても、 `make check` の類は走らないらしいということ。
考えてみればそこまで変な話ではなく、「 Cygwin ホストで Windows ネイティブへのクロスコンパイル」をやったから仕方ないということなんだろう。
テストスイートから渡るパスの引数は Cygwin の表記であって、 Windows の立場では(バックスラッシュとスラッシュの読み替えを含めても)読めないものだ、という失敗のしかたしてたわけだし。

最初に試したのが、2021-09-21朝にダウンロードだけして放ってあった `alpine-virt-3.14.2-x86_64.iso` 。
Cygwin に足すパッケージを少なくとどめてビルドしたので、 SDL などの分かりやすい GUI はなし。
それでも QEMU は組み込みの VNC サーバでエミュレート対象のマシンのグラフィック出力を取り出せるんだから、柔軟でよろしい。
今回は `-nographic` で使わないけどね。
ビルドもさして難しくなかったし、 Alpine Linux はすんなり起動したし、順調。
QEMU に `-nographic` を渡すと、シリアルポート(とモニタ)が stdio につながるので、コンソール触るだけならこれが手軽。

余談: https://twitter.com/yuuta_aoyagi/status/1439252655457538049 のツイートの後もいくらか調べていた結果、有志がインストーラーにパッケージしたビルド済みバイナリを配布してるのと、インストーラーなしで .7z に固めてあるバイナリ(ただし2.6.0まで)を見つけた。
私が探していてなくなったと勘違いしたのは後者で、バージョンが2.6.0というと2016年のもの。
これだけ古いと脆弱性がたくさんあるだろうし常用はしたくない。
ということで、有志の非公式のビルド済みバイナリをインストールするか、自分で野良ビルドするかの2択で、今回は後者を選んだってわけ。(余談ここまで)

年末年始に遊んだのが `amzn2-kvm-2.0.20211201.0-x86_64.xfs.gpt.qcow2` ということで、 Amazon Linux 2を AWS の外で走らせられるってやつ。
最初忘れてた `SHA256SUMS.txt` をダウンロードしたのは帰省の特急の中だったり。
