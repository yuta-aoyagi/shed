# 2022-01-06 memo

https://twitter.com/yuuta_aoyagi/status/1475621868657065989

さて、本件の続き。

## 直接に関係する続きの話

2021-12-25夕方、Cygwin setup-x86\*.exe で Python 3.9系を指定したら、なぜか3.8と3.9の両方をインストールするトランザクションが算出された。
以前 QEMU 6.1.0をビルドしようとしたときに Python 3.x 系を要求されたというだけの動機であり、そこまで新しいものが欲しいわけじゃないので、一度キャンセルして3.8系のみを指定しなおした。

## そのはるか先まで続く別件

再度 QEMU の configure を試したところ、ビルドシステムの ninja が足りないと言われた。
同26日、これをインストール。
その次には glib-gthread のバージョンが合わないと言われた。
Cygwin の mingw64-x86\_64-glib2.0 はそれほど新しくなかったので、 QEMU の GitLab リポジトリで configure の blame を見ていつこのバージョンを要求するようになったかを調べた。
どうやら6.1.0かららしいので、ビルドする QEMU を6.0.1に妥協。
ここまでの準備をすべて終えるとビルドは待つだけで終わった。
「 Cygwin 上で mingw を使ってものをビルドする」というのが初めてでいまいちお作法が分からず、いくつか困惑。

まず、 mingw 側の DLL は `/usr/x86_64-w64-mingw32/sys-root/mingw/bin` にインストールされるらしく、そこに PATH を通すのは手でやった。
これが正しいのかも分からん。
もう一つが、そうやって DLL を読めるようにしてスモークテストとしての `-version` くらいは走ったとしても、 `make check` の類は走らないらしいということ。
考えてみればそこまで変な話ではなく、「 Cygwin ホストで Windows ネイティブへのクロスコンパイル」をやったから仕方ないということなんだろう。
テストスイートから渡るパスの引数は Cygwin の表記であって、 Windows の立場では(バックスラッシュとスラッシュの読み替えを含めても)読めないものだ、という失敗のしかたしてたわけだし。

最初に試したのが、2021-09-21朝にダウンロードだけして放ってあった `alpine-virt-3.14.2-x86_64.iso` 。
Cygwin に足すパッケージを少なくとどめてビルドしたので、 SDL などの分かりやすい GUI はなし。
それでも QEMU は組み込みの VNC サーバでエミュレート対象のマシンのグラフィック出力を取り出せるんだから、柔軟でよろしい。
今回は `-nographic` で使わないけどね。
ビルドもさして難しくなかったし、 Alpine Linux はすんなり起動したし、順調。
QEMU に `-nographic` を渡すと、シリアルポート(とモニタ)が stdio につながるので、コンソール触るだけならこれが手軽。

余談: https://twitter.com/yuuta_aoyagi/status/1439252655457538049 のツイートの後もいくらか調べていた結果、有志がインストーラーにパッケージしたビルド済みバイナリを配布してるのと、インストーラーなしで .7z に固めてあるバイナリ(ただし2.6.0まで)を見つけた。
私が探していてなくなったと勘違いしたのは後者で、バージョンが2.6.0というと2016年のもの。
これだけ古いと脆弱性がたくさんあるだろうし常用はしたくない。
ということで、有志の非公式のビルド済みバイナリをインストールするか、自分で野良ビルドするかの2択で、今回は後者を選んだってわけ。(余談ここまで)

年末年始に遊んだのが `amzn2-kvm-2.0.20211201.0-x86_64.xfs.gpt.qcow2` ということで、 Amazon Linux 2を AWS の外で走らせられるってやつ。
最初忘れてた SHA256SUMS をダウンロードしたのは、帰省の特急の中で不安定なモバイル Wi-Fi 越しだったりする。
さて、 [Amazon Linux 2をオンプレミスで走らせるドキュメント](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/amazon-linux-2-virtual-machine.html) には初回の起動時に行われる設定を ISO ファイルに収める手続きが紹介されているが、実はもっと汎用的に、その初期化は cloud-init の NoCloud データソースを使うことが[明記されている](https://cdn.amazonlinux.com/os-images/2.0.20211201.0/README.cloud-init) 。
このあたりの話は、 https://github.com/awsdocs/amazon-ec2-user-guide/issues/123 の人もおっしゃっている。
それから、 QEMU にはホスト上のディレクトリツリーを FAT な仮想ディスクに見せかける機能があることを[別件](https://knowledge.sakura.ad.jp/23597/) で知っていた。
これは組み合わせるしかないでしょ。
とはいえ、なぜかうまく動かなかったんだけど(具体的なエラーの内容は、忘れたし stderr の古くてもう読めないところに行ってしまった)。
エラーの原因を深追いしなかったのは、 NoCloud データソースが HTTP 越しにも seed を読めるというプラン B があるのを知っていたから。
となれば、ホストで `python -m http.server ${port} &` を準備し、 QEMU 上の Amazon Linux 2に `ds=nocloud-net;s=http[:]//10.0.2[.]2:${port}/` を知らせればよい。

デフォルトの設定で起動させた Amazon Linux 2にはコンソールからログインできるユーザがおそらくなく、最初の起動のときに cloud-init 経由で SSH の公開鍵を設定するのがほぼ前提になっている。
これは AWS の外で走らせようという今回も同じであって、 user-data ファイルを書くのはホスト環境で作った SSH 鍵の公開部分を注入するのが最大の動機である。

さて、 Amazon EC2 で Amazon Linux 2を起動するときには自動生成されたホスト SSH 鍵のフィンガープリントがコンソールに出力されるものだが、ここまでの準備で起動してみたところ、シリアルポートには流れてこなかった。
QEMU ホストの localhost からポート転送で sshd に接続するため、ホスト鍵を検証するのは必須ではないのだが、一応やっておきたい。
というわけで、「 POST リクエストを受け取ったら適当に記録する HTTP サーバ」を適当にホストに用意して、 user-data には「ホスト鍵のフィンガープリントを生成して curl でそっちに POST するワンライナー」を追加した。
これはこれで期待どおりに動いたんだが、このメモの執筆までの数週間にあった何度かの機会で試したところ、シリアルポートにホスト鍵のフィンガープリントが現れることも現れないこともあった。
最初の1回は現れないほうを引いたんだろう。
原因は調べてない。

ここまでの試行錯誤で書いてきたコマンドラインはシェルスクリプトや Makefile の形にまとめた。
他のところで試したくなったら、 SSH 鍵を用意して make コマンドを何回か使うだけで、ディスクイメージの準備・起動・ SSH 接続までを試せるようになっている。

Win10 ノートで運用にミスがあり、2022-01-06の夕方に不意に再起動がかかった。
QEMU 上のゲスト Amazon Linux 2にとっては、クラッシュとかハードシャットダウンとかに見えるんだろう。
