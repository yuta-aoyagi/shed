# 個人的なメモ

開発しながらの思考をダンプしたようなもの。
文章にしておく目的は、何か変更したくなった将来に今の考えを思い出せるようにしておくこと。
他人が読んで役に立つとは期待していない。

## 経緯

この種のスクリプトを開発しようと考えたのは2024-06-13の午前。
最初はよくある shim の形、すなわち「 QEMU や qemu-img を呼び出すシェルスクリプトをまさに `qemu-system-x86_64` や `qemu-img` というファイル名で書き、このディレクトリを PATH に加えること」を目指して14日などは書きかけていたが、これはやめた。

「 PATH を通し(て x ビットを立て)たシェルスクリプトを、異なるディレクトリをカレントとするシェルから、スラッシュを含まないコマンド名で指す(それゆえ PATH 検索を伴う) simple command として実行すること」は移植可能とは限らないと疑問を持ったからである:

- https://x.com/yuuta_aoyagi/status/1801989457295585539
- https://x.com/yuuta_aoyagi/status/1801992858033070349

このマシンの Cygwin では問題ないと経験的に知っていて、移植の計画もないのに、それでも移植性の高い手段にこだわるのはいつもの悪癖。

---

2024-06-16から翌日の深夜までに、「 shim ではなく現在の形ならば、使い勝手が多少悪くなるのと引き換えに先の疑問点を回避できる」と考えをまとめ、下書きを始めた。

このディレクトリ構成をスクリプトで定義することを今月までしてこなかったのは、ハードコードされる変数に暗黙の前提がある(例えばパス名にはスペースなど含むと誤動作しかねない記号が多数ある)ことを忘れないようにするためだった。
目で見て毎回思い出す暗黙知を今回スクリプトに固定するにあたっては、それぞれの変数を防衛的に検証して、問題があれば安全にエラー終了することをもって対策としたい。
そうすると、入力を検査する部分は少なくとも正常ケースとエラーのケースでテストしたくなり、テストしたいということは再現性のある自動テストの形で書きたいということである。
よって、17日23時台 shUnit2 の出番となった: https://x.com/yuuta_aoyagi/status/1802717557516128650

---

行き当たりばったりにテストと実装を交互に書き進めていったところ、 end-to-end に近いテストを書けるところまで整理が進んだ。
2024-06-19には下のような、自動テストのよくあるメリットを実感している感想をメモに残している:

たしかに手間はかかるが、「仕様を実現する実装」と「仕様を検証するテスト」がきっちりかみ合わない限り自動で検出されるので、安心感がかなり強い。
リファクタリングも気負いなく手を出せるし。
対象の実装かまたはテストケースの準備の部分に意図的に誤りを埋め込むことで自動テストを手動テストでき、自動テスト側にバグを見つけたことも何回か。
検出できたバグの実績としては、実装側・テスト側ともに単純な typo のほかシェル変数の export 忘れとかがあった。
(感想ここまで)

これは結局のところ、「雑に書いてほどほどの安心感」を基準とみなすとき「コストをかけて安心感をぐっと増す」という方向である。
対象の複雑さがある程度より低いなら自動テストは割高に見えるだろうけど、「雑に変更して壊れたら直せばいいや」より「土台を固めて安心して高品質な作業」のほうがトータルで安くなるような損益分岐点はもっと低いところにあるのかもしれん。

---

20日25時前に欲しい機能をひととおり書き終わった。
コピペで運用していたときには数十字～百数十字だったハードコードの変数と構造が、検査の実装と自動テスト合わせて二百数十「行」に膨れてる。

---

このスクリプトを動かすにはこのマシンと十分に近いディレクトリ構成を準備しなければならないので、他人の役にはまず立たずよって見せるつもりもなく、数日前まではディレクトリごと .gitignore 指定にでもするつもりだった。
しかし、 [../Makefile](../Makefile) などでこのマシンの実際のディレクトリ構成をすでに明らかにしてしまっているため、このスクリプトだけ非公開としても得られるメリットは特にない。
また、公開リポジトリに push するのは一種のバックアップだとみなせるメリットに気がついたため、一転、公開してもいいと判断を変えた。
その準備として、最小限の [README.md](README.md) およびこの個人的なメモのファイルを書いている。
書くのはいいが、書き始めるとやたら長くなるいつもの悪癖はどうにかならんのか？

## 何か変更したくなった将来の俺へ、申し送り

どれだけ未来から読んでるかは知らんけど。
影響の大きそうな話からだいたい降順に並べる:

- 上で書いたように行き当たりばったりで進めててもどうせ end-to-end テストを整備したくなるので、意識してテストサイズを区別しつつ、全体を開発し直せ。
  自動テストを事後的に検証できるようにするためにも、現在のような「丸ごと作り終えてから Import として `git commit` 」ではなく各ステップでコミットを記録せよ。
- 上の点にも関わるが、 `cygpath` は明確に Cygwin に依存するため、 mock か fake かしてユニットテストを書けるようにせよ。
  実際のコードとしてはある種の Dependency Inection になるだろう。
  環境変数 `QEMUFLAGS` は最後に実装した機能であり区切りを焦っていたため、 `cygpath` の出力を検査する部分のテストが不十分だと自覚している。
  もしかすると、この点に関連して QEMU の実ツールにも fake を加え end-to-end テストとユニットテストを区別してもいいかもしれない。
- シェル変数 `IFS` がどこにどう影響するか調べろ。
- バイト数を測る `wc` にロケールの影響はないか？
- テストで使っているコマンド `touch "$SHOULD_NOT_EXIST"` は、「エラー終了によって実行されなかったこと」をテストできさえすれば他のコマンドでも構わない。
  ただし、テストのデバッグなどで `[set] -x` を使うことがあるので、「コマンドは実行されなかったのに `-x` の出力を誤認する」といった擬陽性を避ける必要がある。
- shUnit2 のより新しいバージョンでは `assertContains` が提供されているとかなり遅れて気がついた。
  テストの `assert_output_includes` を、整合する名前に変更せよ。
- 自問自答: `SHOULD_NOT_EXIST` あるいは `SHUNIT_TMPDIR` について検査を追加すべき条件はあるか？
  適当に遅延してダブルクォート内でしか展開しないからダブルクォートやドルが入ってても実は大丈夫だったように思われる。
  (実際に `TMPDIR` 経由で入り込まれるとしたらだいぶ気持ち悪いけど)
- 現状では「適度に短くてごく限られた種類の文字だけからなる」ことを `accept_only_simple_path` で検査しているが、 POSIX の `portable pathname` という概念に寄せてもいいかもしれない。
  ただし、このパス名は長すぎるかもしれないので、長さの検査だけは独自に残すほうが安全か。
- 「 `[ -f ]` が偽」だとテストするより「 `[ -e ]` が偽」だというほうがより厳格。
  これは難癖に近いだろうが、 touch(1) や creat(2) が作るファイルが regular file である保証を見つけられなかった。
- もしかして `accept_only_simple_path` は `set -e` によって、呼び出し元で exit status の調整を受ける前にプロセスごと終了してない？
